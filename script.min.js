function debugLog(...args){const debugEnabled=document.getElementById("debugSwitch")?.checked;debugEnabled&&console.log("[DEBUG]",...args)}function saveSettings(){const settings={diceCount:document.getElementById("diceCount").value,repeatCount:document.getElementById("repeatCount").value,soundSwitch:document.getElementById("soundSwitch").checked,vibrationSwitch:document.getElementById("vibrationSwitch").checked,showNumberSwitch:document.getElementById("showNumberSwitch").checked,shakeSwitch:document.getElementById("shakeSwitch").checked,historySwitch:document.getElementById("historySwitch").checked,debugSwitch:document.getElementById("debugSwitch")?.checked,diceSize:document.getElementById("diceSize").value,shakeThreshold:shakeThreshold};localStorage.setItem("diceSettings",JSON.stringify(settings)),debugLog("Settings saved:",settings)}function loadSettings(){const savedSettings=localStorage.getItem("diceSettings");if(savedSettings){const settings=JSON.parse(savedSettings);document.getElementById("diceCount").value=settings.diceCount||2,document.getElementById("repeatCount").value=settings.repeatCount||1,document.getElementById("soundSwitch").checked=!1!==settings.soundSwitch,document.getElementById("vibrationSwitch").checked=!1!==settings.vibrationSwitch,document.getElementById("showNumberSwitch").checked=settings.showNumberSwitch||!1,document.getElementById("shakeSwitch").checked=!1!==settings.shakeSwitch,document.getElementById("historySwitch").checked=!1!==settings.historySwitch,document.getElementById("debugSwitch")&&void 0!==settings.debugSwitch&&(document.getElementById("debugSwitch").checked=settings.debugSwitch,document.getElementById("debugSwitchWrapper").style.display=settings.debugSwitch?"flex":"none");const diceSize=settings.diceSize||200;document.getElementById("diceSize").value=diceSize,document.getElementById("diceSizeValue").textContent=diceSize,updateSlider(diceSize),updateDiceSize(diceSize),void 0!==settings.shakeThreshold&&(shakeThreshold=settings.shakeThreshold),debugLog("Settings loaded:",settings)}}let historyRecords=[];const soundUrl="https://cdn.pixabay.com/download/audio/2023/03/14/audio_7763cd5c8a.mp3?filename=dice-142528.mp3";let diceSound=null;function preloadSound(){debugLog("preloadSound"),diceSound||("caches"in window?caches.open("dice-sounds").then((cache=>{cache.match(soundUrl).then((response=>{response?(debugLog("Sound loaded from cache"),response.blob().then((blob=>{diceSound=new Audio(URL.createObjectURL(blob))}))):(debugLog("Sound not in cache, caching now"),fetch(soundUrl).then((response=>{cache.put(soundUrl,response.clone()),response.blob().then((blob=>{debugLog("Sound cached"),diceSound=new Audio(URL.createObjectURL(blob))}))})).catch((err=>{debugLog("Failed to fetch and cache sound",err),diceSound=new Audio(soundUrl)})))})).catch((err=>{debugLog("Cache match error",err),diceSound=new Audio(soundUrl)}))})).catch((err=>{debugLog("Failed to open cache",err),diceSound=new Audio(soundUrl)})):(diceSound=new Audio(soundUrl),diceSound.load()))}function toggleFullScreen(){document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen():document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.webkitRequestFullscreen?document.documentElement.webkitRequestFullscreen():document.documentElement.mozRequestFullScreen&&document.documentElement.mozRequestFullScreen()}function handleFullScreenChange(){const enterIcon=document.getElementById("enterFullscreen"),exitIcon=document.getElementById("exitFullscreen"),mainTitle=document.getElementById("mainTitle"),history=document.getElementById("history"),rollButton=document.getElementById("rollButton"),mainMenu=document.getElementById("mainMenu");debugLog("handleFullScreenChange: "+document.fullscreenElement),document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement?(enterIcon.style.display="none",exitIcon.style.display="block",mainTitle.style.display="none",history.style.display="none",rollButton.style.display="none",mainMenu.style.display="none"):(enterIcon.style.display="block",exitIcon.style.display="none",mainTitle.style.display="block",history.style.display="block",rollButton.style.display="block",mainMenu.style.display="block")}function initFullscreenFeature(){const fullscreenBtn=document.getElementById("fullscreenBtn");document.documentElement.requestFullscreen||document.documentElement.webkitRequestFullscreen||document.documentElement.mozRequestFullScreen||(fullscreenBtn.style.display="none")}function initVibrateFeature(){const vibrationSwitchWrapper=document.getElementById("vibrationSwitch").closest(".switch-wrapper");"vibrate"in navigator||(debugLog("Vibration API not supported"),vibrationSwitchWrapper.style.display="none",document.getElementById("vibrationSwitch").checked=!1)}function createDice(){const dice=document.createElement("div");dice.className="dice";const diceSize=document.getElementById("diceSize").value||200;dice.style.setProperty("--dice-size",diceSize+"px");const showNumbers=document.getElementById("showNumberSwitch").checked;for(let i=1;i<=6;i++){const face=document.createElement("div");face.className=`face face-${i}`,showNumbers?face.textContent=i:createDots(face,i),dice.appendChild(face)}return dice}function createDots(face,value){getDotPositions(value).forEach((pos=>{const dot=document.createElement("div");dot.className="dot",dot.style.top=pos.top,dot.style.left=pos.left,dot.style.transform="translate(-50%, -50%)",face.appendChild(dot)}))}function getDotPositions(value){return{1:[{top:"50%",left:"50%"}],2:[{top:"25%",left:"25%"},{top:"75%",left:"75%"}],3:[{top:"25%",left:"25%"},{top:"50%",left:"50%"},{top:"75%",left:"75%"}],4:[{top:"25%",left:"25%"},{top:"25%",left:"75%"},{top:"75%",left:"25%"},{top:"75%",left:"75%"}],5:[{top:"25%",left:"25%"},{top:"25%",left:"75%"},{top:"50%",left:"50%"},{top:"75%",left:"25%"},{top:"75%",left:"75%"}],6:[{top:"25%",left:"20%"},{top:"25%",left:"50%"},{top:"25%",left:"80%"},{top:"75%",left:"20%"},{top:"75%",left:"50%"},{top:"75%",left:"80%"}]}[value]||[]}function initDices(){const diceContainer=document.getElementById("diceContainer");diceContainer.innerHTML="";const diceCount=parseInt(document.getElementById("diceCount").value);for(let i=0;i<diceCount;i++){const dice=createDice();dice.style.transform="rotateX(90deg) rotateY(0deg)",diceContainer.appendChild(dice)}}document.addEventListener("fullscreenchange",handleFullScreenChange),document.addEventListener("webkitfullscreenchange",handleFullScreenChange),document.addEventListener("mozfullscreenchange",handleFullScreenChange),document.addEventListener("MSFullscreenChange",handleFullScreenChange),document.addEventListener("keydown",(function(event){"F11"===event.key&&setTimeout(handleFullScreenChange,100)}));let currentRollTimeout=null,isContinuousRolling=!1;function rollDice(){debugLog("rollDice");const diceContainer=document.getElementById("diceContainer"),totalElement=document.getElementById("total");if(isContinuousRolling)return clearTimeout(currentRollTimeout),isContinuousRolling=!1,void updateRollButtonText(isContinuousRolling);diceContainer.innerHTML="";let currentRepeat=0;const repeatCount=parseInt(document.getElementById("repeatCount").value);repeatCount>1&&(isContinuousRolling=!0,updateRollButtonText(isContinuousRolling)),function performRoll(){debugLog("进入performRoll函数，当前重复次数:",currentRepeat+1);const diceCount=parseInt(document.getElementById("diceCount").value),rowContainer=document.createElement("div");rowContainer.setAttribute("dice-row",""),rowContainer.style.display="flex",rowContainer.style.flexWrap="wrap",rowContainer.style.justifyContent="center",rowContainer.style.margin="0 15px 30px 15px",diceContainer.appendChild(rowContainer);let total=0;const results=[];document.getElementById("soundSwitch").checked&&(diceSound?debugLog("Using diceSound"):(debugLog("Creating new sound"),diceSound=new Audio(soundUrl)),debugLog("Playing sound"),diceSound.play().catch((err=>{debugLog("Sound play error",err)}))),function(){if(document.getElementById("vibrationSwitch").checked&&"vibrate"in navigator){const pattern=[];let delay=30;for(let i=0;i<5;i++)pattern.push(50+30*Math.random()),pattern.push(delay),delay+=40*Math.random();navigator.vibrate(pattern)}}();for(let i=0;i<diceCount;i++){const dice=createDice(),result=Math.floor(6*Math.random())+1,rotations={1:{x:0,y:0},2:{x:0,y:180},3:{x:0,y:-90},4:{x:0,y:90},5:{x:-90,y:0},6:{x:90,y:0}},randomMultiplier=5+5*Math.random(),initialXRot=rotations[result].x+Math.floor(360*Math.random())*randomMultiplier,initialYRot=rotations[result].y+Math.floor(360*Math.random())*randomMultiplier,initialZRot=Math.floor(360*Math.random())*randomMultiplier;dice.style.transform=`rotateX(${initialXRot}deg) rotateY(${initialYRot}deg) rotateZ(${initialZRot}deg)`,dice.style.transition="transform 1.5s cubic-bezier(0.2, 0.6, 0.1, 1)",setTimeout((()=>{const finalX=rotations[result].x,finalY=rotations[result].y;dice.style.transform=`rotateX(${finalX}deg) rotateY(${finalY}deg)`}),100),rowContainer.appendChild(dice),results.push(result),total+=result,i===diceCount-1&&(currentRollTimeout=setTimeout((()=>{totalElement.textContent=total;if(document.getElementById("historySwitch").checked){const record={time:(new Date).toLocaleTimeString(),diceCount:diceCount,results:results,total:total};historyRecords.push(record),updateHistoryDisplay()}currentRepeat++,currentRepeat<repeatCount&&isContinuousRolling?currentRollTimeout=setTimeout(performRoll,1e3):(isContinuousRolling=!1,updateRollButtonText(isContinuousRolling))}),1500))}}()}function updateDiceSize(size){document.querySelectorAll(".dice").forEach((dice=>{dice.style.setProperty("--dice-size",size+"px")}))}function updateSlider(value){const diceSizeSlider=document.getElementById("diceSize"),diceSizeFloating=document.getElementById("diceSizeFloating"),floatingValue=document.getElementById("floatingSliderValue"),diceSizeFloatingRect=(document.querySelector(".dice-size-wrapper"),diceSizeFloating.getBoundingClientRect()),min=diceSizeSlider.min||0,percent=(value-min)/((diceSizeSlider.max||100)-min)*100;diceSizeSlider.style.background=`linear-gradient(to right, #4CAF50 0%, #4CAF50 ${percent}%, #ccc ${percent}%, #ccc 100%)`,diceSizeFloating.style.background=`linear-gradient(to right, #4CAF50 0%, #4CAF50 ${percent}%, #ccc ${percent}%, #ccc 100%)`;const sliderWidth=diceSizeFloatingRect.width,x=diceSizeFloatingRect.left+(sliderWidth-20)*percent/100+10;floatingValue.style.left=x+"px",floatingValue.style.top=diceSizeFloatingRect.top-30+"px",floatingValue.textContent=diceSizeSlider.value+"%"}function initDiceSizeControl(){document.getElementById("diceSize").addEventListener("input",(function(e){const size=e.target.value;document.getElementById("diceSizeValue").textContent=size,updateDiceSize(size)})),document.getElementById("diceSizeValue").addEventListener("blur",(function(e){let value=parseInt(e.target.textContent)||200;value=Math.max(50,Math.min(300,value)),e.target.textContent=value,document.getElementById("diceSize").value=value,updateSlider(value),updateDiceSize(value),saveSettings()})),document.getElementById("diceSizeValue").addEventListener("keydown",(function(e){"Enter"===e.key&&(e.preventDefault(),e.target.blur())}));const diceSizeSlider=document.getElementById("diceSize"),diceSizeFloating=document.getElementById("diceSizeFloating"),menuContainer=document.getElementById("menuContainer"),diceSizeWrapper=document.querySelector(".dice-size-wrapper"),floatingValue=document.getElementById("floatingSliderValue");diceSizeSlider.addEventListener("input",(function(){diceSizeFloating.value=this.value,document.getElementById("diceSizeValue").textContent=this.value,updateSlider(diceSizeFloating.value)})),diceSizeFloating.addEventListener("input",(function(){diceSizeSlider.value=this.value,document.getElementById("diceSizeValue").textContent=this.value,updateDiceSize(this.value),updateSlider(diceSizeFloating.value)}));let isSliderDragging=!1;function showFloatingSlider(e){diceSizeSlider.getBoundingClientRect();const wrapperRect=diceSizeWrapper.getBoundingClientRect();diceSizeFloating.style.left=wrapperRect.left+"px",diceSizeFloating.style.top=wrapperRect.top+"px",diceSizeFloating.style.display="block",floatingValue.style.display="block",diceSizeFloating.value=diceSizeSlider.value,updateSlider(diceSizeFloating.value)}function hideFloatingSlider(){diceSizeFloating.style.display="none",floatingValue.style.display="none"}diceSizeSlider.addEventListener("mousedown",(function(e){isSliderDragging=!0,showFloatingSlider(e),menuContainer.style.opacity=0})),diceSizeSlider.addEventListener("touchstart",(function(e){isSliderDragging=!0,showFloatingSlider(e.touches[0]),menuContainer.style.opacity=0})),document.addEventListener("mousemove",(function(e){isSliderDragging&&updateDiceSize(diceSizeFloating.value)})),document.addEventListener("mouseup",(function(){isSliderDragging&&(isSliderDragging=!1,hideFloatingSlider(),menuContainer.style.opacity="1")})),document.addEventListener("touchmove",(function(e){isSliderDragging&&updateDiceSize(diceSizeFloating.value)})),document.addEventListener("touchend",(function(){isSliderDragging&&(isSliderDragging=!1,hideFloatingSlider(),menuContainer.style.opacity="1")}))}function initSettingsControl(){document.getElementById("menuContainer").addEventListener("change",(function(e){debugLog("setting change: "+e.target.id),"diceCount"!==e.target.id&&"showNumberSwitch"!==e.target.id||redrawDice(),"repeatCount"===e.target.id&&updateRollButtonText(isContinuousRolling),"shakeSwitch"!==e.target.id&&("debugSwitch"===e.target.id&&(debugSwitchWrapper.style.display=this.checked?"flex":"none",this.checked||removeAccelerationOverlay()),saveSettings())}))}function updateHistoryDisplay(){const historyList=document.getElementById("historyList"),historyContainer=document.getElementById("history"),historyIcon=document.querySelector(".history-icon"),clearBtn=document.querySelector(".clear-history"),historyCount=document.getElementById("historyCount"),historyRightGroup=document.querySelector(".history-right-group");if(historyList.innerHTML="",0===historyRecords.length)return historyContainer.classList.remove("visible","visible-more","expanded"),historyIcon.classList.remove("prompt"),historyIcon.style.display="none",clearBtn.style.display="none",historyCount.style.display="none",void(historyRightGroup.style.display="none");const history=document.getElementById("history");historyRecords.length>1?(history.classList.add("visible-more"),history.classList.remove("visible")):(history.classList.add("visible"),history.classList.remove("visible-more")),historyIcon.style.display="block",historyIcon.classList.add("prompt"),clearBtn.style.display="inline-block",historyCount.style.display="inline-block",historyRightGroup.style.display="inline-block",historyCount.textContent=`${historyRecords.length}次`;const recordsToShow=historyRecords.slice(-100);if(recordsToShow.forEach(((record,index)=>{const recordElement=document.createElement("div");recordElement.className="history-item",index===recordsToShow.length-1&&recordElement.classList.add("insert-animation");const actualIndex=historyRecords.length-recordsToShow.length+index+1;recordElement.innerHTML=`\n            <div style="display:flex; justify-content:space-between">\n                <span><strong>${actualIndex}. 点数：<span style="color:#4CAF50">${record.total}</span></strong></span>\n                <span style="color:#666">${record.time}</span>\n            </div>\n            <div style="font-size:0.9em; color:#666">\n                ${record.diceCount}个骰子: ${record.results.join(", ")}\n            </div>\n        `,historyList.insertBefore(recordElement,historyList.firstChild)})),historyRecords.length>100){const infoElement=document.createElement("div");infoElement.className="history-info",infoElement.textContent=`仅显示最近 100 条记录，共 ${historyRecords.length} 条`,historyList.appendChild(infoElement)}}function toggleHistory(e){if(e&&"click"===e.type&&isHistoryDragging)return;debugLog("toggleHistory"),e&&e.stopPropagation();const historyContainer=document.getElementById("history"),historyIcon=document.querySelector(".history-icon");historyRecords.length>0&&(debugLog("toggleHistory: has history"),historyContainer.classList.toggle("expanded"),historyIcon.classList.toggle("up"),historyIcon.classList.remove("prompt"))}let isHistoryDragging=!1;function initHistoryDragFeature(){const historyHeader=document.getElementById("historyHeader"),historyContainer=document.getElementById("history");let startY,startHeight,containerHeight;function startDrag(e){e.touches&&e.touches.length>1||0!==historyRecords.length&&(debugLog("startDrag"),isHistoryDragging=!0,startY=e.clientY||(e.touches?e.touches[0].clientY:0),startHeight=historyContainer.offsetHeight,containerHeight=window.innerHeight,historyContainer.classList.add("no-transition"),document.addEventListener("mousemove",drag),document.addEventListener("touchmove",drag),document.addEventListener("mouseup",endDrag),document.addEventListener("touchend",endDrag),e.preventDefault())}function drag(e){if(!isHistoryDragging)return;debugLog("drag");const currentY=e.clientY||(e.touches?e.touches[0].clientY:0),newHeight=startHeight-(currentY-startY);debugLog(`newHeight: ${newHeight}`);const maxHeight=.6*containerHeight,minHeight=.1*containerHeight;debugLog(`newHeight: ${newHeight}, maxHeight: ${maxHeight}, minHeight: ${minHeight}`),historyContainer.style.height=newHeight>=minHeight&&newHeight<=maxHeight?`${newHeight}px`:newHeight<minHeight?`${minHeight}px`:`${maxHeight}px`,updateHeightConstraints(),e.preventDefault()}function endDrag(e){if(!isHistoryDragging)return;debugLog("endDrag");const deltaY=(e.clientY||(e.changedTouches&&e.changedTouches[0]?e.changedTouches[0].clientY:e.touches&&e.touches[0]?e.touches[0].clientY:0))-startY;if(Math.abs(deltaY)<5)debugLog("点击判断: "+e.target.id),"clear-history"===e.target.id?clearHistory(e):toggleHistory();else{const maxHeight=.6*containerHeight,minHeight=.2*containerHeight;let finalHeight;deltaY<-5?finalHeight=Math.min(startHeight+Math.abs(deltaY),maxHeight):deltaY>5&&(finalHeight=Math.max(startHeight-Math.abs(deltaY),minHeight)),historyContainer.classList.toggle("expanded",finalHeight>.4*containerHeight)}historyContainer.style.height="",historyContainer.classList.remove("no-transition"),document.removeEventListener("mousemove",drag),document.removeEventListener("touchmove",drag),document.removeEventListener("mouseup",endDrag),document.removeEventListener("touchend",endDrag),setTimeout((()=>{isHistoryDragging=!1}),200)}historyHeader.addEventListener("mousedown",startDrag),historyHeader.addEventListener("touchstart",startDrag)}function updateHeightConstraints(){const historyContainer=document.getElementById("history"),historyIcon=document.querySelector(".history-icon");(parseInt(historyContainer.style.height)||historyContainer.offsetHeight)>.4*window.innerHeight?historyIcon.classList.add("up"):historyIcon.classList.remove("up")}function clearHistory(e){e.stopPropagation(),confirm("确定要清空所有历史记录吗？")&&(historyRecords=[],updateHistoryDisplay())}function updateRollButtonText(running){const rollButton=document.getElementById("rollButton");if(running)rollButton.textContent="停止";else{const repeatCount=parseInt(document.getElementById("repeatCount").value);rollButton.textContent=repeatCount>1?"连续掷":"掷骰子"}}function redrawDice(){const diceContainer=document.getElementById("diceContainer"),diceCount=parseInt(document.getElementById("diceCount").value),rows=diceContainer.querySelectorAll("div[dice-row]");0!==rows.length&&rows.forEach((row=>{let diceValues=Array.from(row.querySelectorAll(".dice")).map((dice=>getDiceValueFromRotation(dice.style.transform)));if(diceValues.length>diceCount)diceValues=diceValues.slice(0,diceCount);else if(diceValues.length<diceCount){const diff=diceCount-diceValues.length;for(let i=0;i<diff;i++)diceValues.push(Math.floor(6*Math.random())+1)}row.innerHTML="",diceValues.forEach((value=>{const dice=createDice(),rotations={1:{x:0,y:0},2:{x:0,y:180},3:{x:0,y:-90},4:{x:0,y:90},5:{x:-90,y:0},6:{x:90,y:0}};if(value>=1&&value<=6)dice.style.transform=`rotateX(${rotations[value].x}deg) rotateY(${rotations[value].y}deg)`;else{const randomValue=Math.floor(6*Math.random())+1;dice.style.transform=`rotateX(${rotations[randomValue].x}deg) rotateY(${rotations[randomValue].y}deg)`}row.appendChild(dice)}))}))}function getDiceValueFromRotation(transform){if(!transform)return null;const matches=transform.match(/rotateX\(([-0-9.]+)deg\)\s+rotateY\(([-0-9.]+)deg\)/);if(!matches)return null;const xRot=parseFloat(matches[1])%360,yRot=parseFloat(matches[2])%360;return Math.abs(xRot)<45&&Math.abs(yRot)<45?1:Math.abs(yRot-180)<45?2:Math.abs(yRot+90)<45?3:Math.abs(yRot-90)<45?4:Math.abs(xRot+90)<45?5:Math.abs(xRot-90)<45?6:null}function adjustNumber(id,delta){const input=document.getElementById(id);if(!input)return;let value=parseInt(input.value)||0;value+=delta,input.hasAttribute("min")&&(value=Math.max(value,parseInt(input.min))),input.hasAttribute("max")&&(value=Math.min(value,parseInt(input.max))),input.value=value,redrawDice(),isContinuousRolling||updateRollButtonText(isContinuousRolling),saveSettings()}function toggleMenu(){const menu=document.getElementById("menuContainer"),btn=document.querySelector(".menu-btn");menu.classList.contains("active");menu.classList.toggle("active"),btn.classList.toggle("active")}function handleBodyClick(e){if(isHistoryDragging)return void(isHistoryDragging=!1);if(e.target.closest(".menu-btn")||e.target.closest("#menuContainer"))return;if(e.target.closest(".fullscreen-btn")||e.target.closest("#fullscreenIcon"))return;if(e.target.closest("#history")||e.target.closest(".history-icon"))return;if(e.target.closest("button")||e.target.closest("a"))return;debugLog("body clicked, need process");const menu=document.getElementById("menuContainer"),historyContainer=document.getElementById("history");menu.classList.contains("active")?toggleMenu():historyContainer.classList.contains("expanded")?toggleHistory():rollDice()}function showRequestDeviceMotionPermission(isShow){document.getElementById("requestDeviceMotionPermission").style.visibility=isShow?"visible":"hidden"}let lastAcceleration={x:null,y:null,z:null},lastShakeTime=0,shakeThreshold=12,accelerationHistory=[];function handleDeviceMotion(event){if(!document.getElementById("shakeSwitch").checked)return;const acceleration=event.acceleration||event.accelerationIncludingGravity;if(!acceleration)return;if(showRequestDeviceMotionPermission(!1),null===lastAcceleration.x)return void(lastAcceleration={x:acceleration.x,y:acceleration.y,z:acceleration.z});const deltaX=Math.abs(acceleration.x-lastAcceleration.x),deltaY=Math.abs(acceleration.y-lastAcceleration.y),deltaZ=Math.abs(acceleration.z-lastAcceleration.z);if(deltaX>2||deltaY>2||deltaZ>2){debugLog(`加速度变化: x=${deltaX}, y=${deltaY}, z=${deltaZ}`);if(document.getElementById("debugSwitch")?.checked||!1){const accelData={time:Date.now(),x:deltaX?deltaX.toFixed(2):"N/A",y:deltaY?deltaY.toFixed(2):"N/A",z:deltaZ?deltaZ.toFixed(2):"N/A"};accelerationHistory.push(accelData),accelerationHistory.length>100&&accelerationHistory.shift(),updateAccelerationDisplay()}}lastAcceleration={x:acceleration.x,y:acceleration.y,z:acceleration.z},(deltaX>shakeThreshold&&deltaY>shakeThreshold||deltaX>shakeThreshold&&deltaZ>shakeThreshold||deltaY>shakeThreshold&&deltaZ>shakeThreshold)&&Date.now()-lastShakeTime>1e3&&(rollDice(),lastShakeTime=Date.now())}function isDeviceMotionSupported(){return"DeviceMotionEvent"in window}function requestDeviceMotionPermission(){return"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((permissionState=>"granted"===permissionState?(debugLog("Device motion permission granted"),!0):(debugLog("Device motion permission denied"),!1))).catch((error=>(debugLog("Device motion permission error:",error),!1))):Promise.resolve(!0)}function initShakeFeature(){const shakeSwitch=document.getElementById("shakeSwitch"),shakeSwitchWrapper=shakeSwitch.closest(".switch-wrapper");let shakeSwitchClickCount=0,clickTimer=null;if(!isDeviceMotionSupported())return debugLog("Device motion not supported"),shakeSwitchWrapper.style.display="none",void(shakeSwitch.checked=!1);shakeSwitchWrapper.addEventListener("click",(function(e){if(e.target!==shakeSwitch&&e.target!==shakeSwitch.nextElementSibling&&(shakeSwitchClickCount++,debugLog("shakeSwitchClickCount: "+shakeSwitchClickCount),clickTimer&&clearTimeout(clickTimer),clickTimer=setTimeout((()=>{shakeSwitchClickCount=0}),1e3),shakeSwitchClickCount>=5)){shakeSwitchClickCount=0;const newThreshold=prompt("摇一摇灵敏度 (默认为12):",shakeThreshold);null!==newThreshold&&!isNaN(newThreshold)&&newThreshold>0&&(shakeThreshold=parseInt(newThreshold),debugLog(`新的摇一摇阈值设置为: ${shakeThreshold}`),saveSettings())}})),shakeSwitch.checked&&(window.addEventListener("devicemotion",handleDeviceMotion),setTimeout((()=>{null===lastAcceleration.x&&"function"==typeof DeviceMotionEvent.requestPermission&&showRequestDeviceMotionPermission(!0)}),500)),shakeSwitch.addEventListener("change",(async function(){if(this.checked){await requestDeviceMotionPermission()?(window.addEventListener("devicemotion",handleDeviceMotion),saveSettings()):(this.checked=!1,alert("需要设备运动权限才能使用“摇一摇”功能"))}else window.removeEventListener("devicemotion",handleDeviceMotion),showRequestDeviceMotionPermission(!1),saveSettings()}))}function initDebugFeature(){const about=document.getElementById("about"),debugSwitch=document.getElementById("debugSwitch");let aboutClickCount=0,clickTimer=null;about&&about.addEventListener("click",(function(){!debugSwitch.checked&&(aboutClickCount++,debugLog(`aboutClickCount: ${aboutClickCount}`),clickTimer&&clearTimeout(clickTimer),clickTimer=setTimeout((()=>{aboutClickCount=0}),1e3),aboutClickCount>=5)&&(aboutClickCount=0,confirm("是否开启调试模式？")&&function(enable){const debugSwitchWrapper=document.getElementById("debugSwitchWrapper");debugSwitchWrapper&&debugSwitch&&(debugSwitchWrapper.style.display=enable?"flex":"none",debugSwitch.checked=enable,saveSettings())}(!0))}))}function createAccelerationOverlay(){debugLog("创建加速度显示覆盖层");const overlay=document.createElement("div");overlay.id="accelerationOverlay",overlay.style.cssText="\n        position: fixed;\n        top: 10px;\n        left: 10px;\n        width: 300px;\n        max-height: 200px;\n        background: rgba(0, 0, 0, 0.8);\n        color: white;\n        padding: 10px;\n        border-radius: 5px;\n        font-family: monospace;\n        font-size: 12px;\n        z-index: 1000;\n        overflow-y: auto;\n        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);\n    ";const title=document.createElement("div");title.id="AccelerationOverlayTitle",title.innerHTML="<strong>加速度数据 (灵敏度："+shakeThreshold+")</strong>",title.style.marginBottom="5px",overlay.appendChild(title);const content=document.createElement("div");content.id="accelerationContent",content.style.cssText="white-space: pre;",overlay.appendChild(content),document.body.appendChild(overlay)}function removeAccelerationOverlay(){const overlay=document.getElementById("accelerationOverlay");overlay&&overlay.remove(),accelerationHistory=[]}function updateAccelerationDisplay(){debugLog("updateAccelerationDisplay"),document.getElementById("accelerationOverlay")||createAccelerationOverlay(),document.getElementById("AccelerationOverlayTitle").innerHTML="<strong>加速度数据 (灵敏度："+shakeThreshold+")</strong>";const content=document.getElementById("accelerationContent");if(!content)return;if(0===accelerationHistory.length)return void(content.textContent="等待数据...");const displayData=accelerationHistory.slice(-20).reverse();let text="";displayData.forEach((data=>{const timestamp=new Date(data.time).toLocaleTimeString(),xOverThreshold=Math.abs(parseFloat(data.x))>shakeThreshold,yOverThreshold=Math.abs(parseFloat(data.y))>shakeThreshold,zOverThreshold=Math.abs(parseFloat(data.z))>shakeThreshold,xDisplay=xOverThreshold?`<span style="color: red;">${data.x.toString().padStart(6," ")}</span>`:`<span>${data.x.toString().padStart(6," ")}</span>`,yDisplay=yOverThreshold?`<span style="color: red;">${data.y.toString().padStart(6," ")}</span>`:`<span>${data.y.toString().padStart(6," ")}</span>`,zDisplay=zOverThreshold?`<span style="color: red;">${data.z.toString().padStart(6," ")}</span>`:`<span>${data.z.toString().padStart(6," ")}</span>`;text+=`${timestamp} X:${xDisplay} Y:${yDisplay} Z:${zDisplay}\n`})),content.innerHTML=text}window.onload=function(){debugLog("页面加载完成"),loadSettings(),preloadSound(),initFullscreenFeature(),initVibrateFeature(),initShakeFeature(),initDices(),initDiceSizeControl(),initSettingsControl(),initHistoryDragFeature(),initDebugFeature()};